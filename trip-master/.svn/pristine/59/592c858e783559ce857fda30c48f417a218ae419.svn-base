package com.newroad.tripmaster.filter;

import java.io.IOException;
import java.io.PrintWriter;
import java.net.URLDecoder;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import net.sf.json.JSONObject;

import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.ApplicationContext;
import org.springframework.web.context.support.WebApplicationContextUtils;

import com.newroad.tripmaster.service.client.TripMasterHttpClient;
import com.newroad.util.auth.TokenUtil;

/**
 * @info : 
 * @author: tangzj1
 * @data : 2013-9-11
 * @since : 1.5
 */
public class TokenAuthFilter implements Filter {

  private final Logger logger = LoggerFactory.getLogger(TokenAuthFilter.class);
  /**
   * ThreadLocal points to the current thread
   */
  private static ThreadLocal<JSONObject> current = new ThreadLocal<JSONObject>();

  private TripMasterHttpClient restClient;

  /**
   * URL
   */
  private String urlRegx;


  public void init(FilterConfig filterConfig) throws ServletException {
    urlRegx = filterConfig.getInitParameter("urlRegx");

    ServletContext context = filterConfig.getServletContext();
    ApplicationContext ac = WebApplicationContextUtils.getWebApplicationContext(context);
    restClient = (TripMasterHttpClient) ac.getBean("restClient");
  }


  public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
    HttpServletRequest req = (HttpServletRequest) request;
    HttpServletResponse res = (HttpServletResponse) response;
    String url = req.getRequestURI();

    if (!url.matches(urlRegx)) {
      chain.doFilter(request, response);
      return;
    }
    String token = req.getHeader(TokenUtil.AUTH_TOKEN);
    // String uid = req.getHeader(FullTextSearchConstants.USERID);

    if (StringUtils.isBlank(token))
      token = req.getParameter(TokenUtil.AUTH_TOKEN);

    if (StringUtils.isBlank(token)) {
      Cookie[] cookies = ((HttpServletRequest) request).getCookies();
      if (cookies != null) {
        for (Cookie cookie : cookies) {
          if ("token".equals(cookie.getName())) {
            token = URLDecoder.decode(cookie.getValue(), "UTF-8");
            token = token.replace("\"", "");
          }
        }
      }
    }

    if (StringUtils.isBlank(token)) {
      out(res, "{returnCode:401, returnMessage:'No AuthToken in Http head!'}");
      logger.warn("No AuthToken in Http head!");
      return;
    }

    // Need to change app type according to client request.
    String app = "trip-master";
    logger.info("token=" + token + ";app=" + app);
    JSONObject session = restClient.checkAuth(token, app);
    if (session == null) {
      out(res, "{returnCode:403, returnMessage:'The AuthToken is fail or expired!'}");
      logger.warn("The AuthToken[" + token + "] is fail or expired!");
      return;
    }

    current.set(session);
    try {
      chain.doFilter(request, response);
    } finally {
      current.remove();
    }
  }

  void out(HttpServletResponse res, String json) {
    res.setContentType("application/json;charset=UTF-8");
    try {
      PrintWriter out = res.getWriter();
      out.write(json);
      out.close();
    } catch (Exception e) {
      logger.error("token filter response print out error!", e);
    }
  }

  public void destroy() {}

  public static JSONObject getCurrent() {
    JSONObject session = current.get();
    if (session == null)
      return null;
    return session;
  }
  
  public static Long getCurrentUser(){
    Long userId=null;
    JSONObject session=getCurrent();
    if(session!=null){
      userId=session.getLong("userID");
    }
    return userId;
  }
}
